generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Alert {
  id                          String      @id
  message                     String
  status                      AlertStatus @default(UNREAD)
  orderId                     String
  senderId                    String
  receiverId                  String
  createdAt                   DateTime    @default(now())
  readAt                      DateTime?
  resolvedAt                  DateTime?
  Order                       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  User_Alert_receiverIdToUser User        @relation("Alert_receiverIdToUser", fields: [receiverId], references: [id], onDelete: Cascade)
  User_Alert_senderIdToUser   User        @relation("Alert_senderIdToUser", fields: [senderId], references: [id], onDelete: Cascade)
  AuditLog                    AuditLog[]

  @@index([createdAt])
  @@index([orderId])
  @@index([receiverId])
  @@index([senderId])
  @@index([status])
}

model AuditLog {
  id         String      @id
  action     AuditAction
  entityType String
  entityId   String
  oldValue   String?
  newValue   String?
  metadata   Json?
  userId     String
  ipAddress  String?
  userAgent  String?
  orderId    String?
  fileId     String?
  alertId    String?
  createdAt  DateTime    @default(now())
  Alert      Alert?      @relation(fields: [alertId], references: [id], onDelete: Cascade)
  File       File?       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  Order      Order?      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  User       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([orderId])
  @@index([userId])
}

model Clinic {
  id                                  String         @id
  name                                String
  email                               String?
  phone                               String?
  address                             String?
  isActive                            Boolean        @default(true)
  laboratoryId                        String
  createdAt                           DateTime       @default(now())
  updatedAt                           DateTime
  Laboratory                          Laboratory     @relation(fields: [laboratoryId], references: [id], onDelete: Cascade)
  DoctorClinic                        DoctorClinic[]
  Order                               Order[]
  User_User_assistantClinicIdToClinic User[]         @relation("User_assistantClinicIdToClinic")
  User_User_clinicIdToClinic          User[]         @relation("User_clinicIdToClinic")

  @@index([isActive])
  @@index([laboratoryId])
}

model DoctorAssistant {
  id                                     String   @id
  doctorId                               String
  assistantId                            String
  createdAt                              DateTime @default(now())
  User_DoctorAssistant_assistantIdToUser User     @relation("DoctorAssistant_assistantIdToUser", fields: [assistantId], references: [id], onDelete: Cascade)
  User_DoctorAssistant_doctorIdToUser    User     @relation("DoctorAssistant_doctorIdToUser", fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, assistantId])
  @@index([assistantId])
  @@index([doctorId])
}

model DoctorClinic {
  id        String   @id
  doctorId  String
  clinicId  String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, clinicId])
  @@index([clinicId])
  @@index([doctorId])
}

model File {
  id           String     @id
  fileName     String
  originalName String
  fileType     String
  fileSize     Int
  mimeType     String
  storageKey   String     @unique
  storageUrl   String
  category     String?
  thumbnailUrl String?
  isProcessed  Boolean    @default(false)
  orderId      String
  uploadedById String
  createdAt    DateTime   @default(now())
  expiresAt    DateTime?
  deletedAt    DateTime?
  AuditLog     AuditLog[]
  Order        Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  User         User       @relation(fields: [uploadedById], references: [id])

  @@index([category])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([orderId])
  @@index([storageKey])
  @@index([uploadedById])
}

model Laboratory {
  id                                      String   @id
  name                                    String
  email                                   String?
  phone                                   String?
  address                                 String?
  isActive                                Boolean  @default(true)
  createdAt                               DateTime @default(now())
  updatedAt                               DateTime
  Clinic                                  Clinic[]
  User_User_labCollaboratorIdToLaboratory User[]   @relation("User_labCollaboratorIdToLaboratory")
  User_User_laboratoryIdToLaboratory      User[]   @relation("User_laboratoryIdToLaboratory")

  @@index([isActive])
}

model Order {
  id                           String           @id
  orderNumber                  String           @unique
  patientName                  String
  patientId                    String?
  description                  String?
  notes                        String?
  fechaEntregaDeseada          DateTime?
  aiPrompt                     String?
  teethNumbers                 String?
  material                     String?
  materialBrand                String?
  color                        String?
  scanType                     ScanType?
  tipoCaso                     CaseType?        @default(nuevo)
  motivoGarantia               String?
  seDevuelveTrabajoOriginal    Boolean?
  tipoTrabajo                  WorkType?        @default(restauracion)
  tipoRestauracion             RestorationType?
  escanerUtilizado             ScannerType?
  otroEscaner                  String?
  tipoSilicon                  SiliconType?
  notaModeloFisico             String?
  trabajoSobreImplante         Boolean?         @default(false)
  informacionImplante          Json?
  materialSent                 Json?
  submissionType               SubmissionType?  @default(terminado)
  oclusionDiseno               Json?
  colorInfo                    Json?
  articulatedBy                ArticulatedBy?   @default(doctor)
  status                       OrderStatus      @default(DRAFT)
  clinicId                     String
  createdById                  String
  doctorId                     String
  createdAt                    DateTime         @default(now())
  updatedAt                    DateTime
  submittedAt                  DateTime?
  materialsSentAt              DateTime?
  completedAt                  DateTime?
  Alert                        Alert[]
  AuditLog                     AuditLog[]
  File                         File[]
  Clinic                       Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  User_Order_createdByIdToUser User             @relation("Order_createdByIdToUser", fields: [createdById], references: [id], onDelete: Cascade)
  User_Order_doctorIdToUser    User             @relation("Order_doctorIdToUser", fields: [doctorId], references: [id], onDelete: Cascade)
  OrderComment                 OrderComment[]

  @@index([clinicId])
  @@index([createdAt])
  @@index([createdById])
  @@index([doctorId])
  @@index([orderNumber])
  @@index([status])
}

model OrderComment {
  id         String   @id
  content    String
  isInternal Boolean  @default(false)
  orderId    String
  authorId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  User       User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  Order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([isInternal])
  @@index([orderId])
}

model User {
  id                                                String            @id
  email                                             String            @unique
  name                                              String
  passwordHash                                      String
  role                                              Role
  laboratoryId                                      String?
  labCollaboratorId                                 String?
  clinicId                                          String?
  activeClinicId                                    String?
  assistantClinicId                                 String?
  createdAt                                         DateTime          @default(now())
  updatedAt                                         DateTime
  Alert_Alert_receiverIdToUser                      Alert[]           @relation("Alert_receiverIdToUser")
  Alert_Alert_senderIdToUser                        Alert[]           @relation("Alert_senderIdToUser")
  AuditLog                                          AuditLog[]
  DoctorAssistant_DoctorAssistant_assistantIdToUser DoctorAssistant[] @relation("DoctorAssistant_assistantIdToUser")
  DoctorAssistant_DoctorAssistant_doctorIdToUser    DoctorAssistant[] @relation("DoctorAssistant_doctorIdToUser")
  DoctorClinic                                      DoctorClinic[]
  File                                              File[]
  Order_Order_createdByIdToUser                     Order[]           @relation("Order_createdByIdToUser")
  Order_Order_doctorIdToUser                        Order[]           @relation("Order_doctorIdToUser")
  OrderComment                                      OrderComment[]
  Clinic_User_assistantClinicIdToClinic             Clinic?           @relation("User_assistantClinicIdToClinic", fields: [assistantClinicId], references: [id], onDelete: Cascade)
  Clinic_User_clinicIdToClinic                      Clinic?           @relation("User_clinicIdToClinic", fields: [clinicId], references: [id], onDelete: Cascade)
  Laboratory_User_labCollaboratorIdToLaboratory     Laboratory?       @relation("User_labCollaboratorIdToLaboratory", fields: [labCollaboratorId], references: [id], onDelete: Cascade)
  Laboratory_User_laboratoryIdToLaboratory          Laboratory?       @relation("User_laboratoryIdToLaboratory", fields: [laboratoryId], references: [id], onDelete: Cascade)

  @@index([activeClinicId])
  @@index([assistantClinicId])
  @@index([clinicId])
  @@index([email])
  @@index([laboratoryId])
  @@index([role])
}

enum AlertStatus {
  UNREAD
  READ
  RESOLVED
}

enum ArticulatedBy {
  doctor
  laboratorio
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  REGISTER
  FILE_UPLOAD
  FILE_DOWNLOAD
  FILE_DELETE
  STATUS_CHANGE
  ALERT_SENT
  ALERT_READ
}

enum CaseType {
  nuevo
  garantia
}

enum OrderStatus {
  DRAFT
  PENDING_REVIEW
  MATERIALS_SENT
  NEEDS_INFO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RestorationType {
  corona
  puente
  inlay
  onlay
  carilla
  provisional
}

enum Role {
  LAB_ADMIN
  LAB_COLLABORATOR
  CLINIC_ADMIN
  DOCTOR
  CLINIC_ASSISTANT
}

enum ScanType {
  DIGITAL_SCAN
  ANALOG_MOLD
}

enum ScannerType {
  iTero
  Medit
  ThreeShape
  Carestream
  Otro
}

enum SiliconType {
  adicion
  condensacion
}

enum SubmissionType {
  prueba_estructura
  prueba_estetica
  terminado
}

enum WorkType {
  restauracion
  otro
}
