generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Alert {
  id                          String      @id @default(cuid())
  message                     String
  status                      AlertStatus @default(UNREAD)
  orderId                     String
  senderId                    String
  receiverId                  String
  createdAt                   DateTime    @default(now())
  readAt                      DateTime?
  resolvedAt                  DateTime?
  order                       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender                      User        @relation("AlertSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver                    User        @relation("AlertReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  auditLogs                   AuditLog[]

  @@index([createdAt])
  @@index([orderId])
  @@index([receiverId])
  @@index([senderId])
  @@index([status])
}

model AuditLog {
  id         String      @id @default(cuid())
  action     AuditAction
  entityType String
  entityId   String
  oldValue   String?
  newValue   String?
  metadata   Json?
  userId     String
  ipAddress  String?
  userAgent  String?
  orderId    String?
  fileId     String?
  alertId    String?
  createdAt  DateTime    @default(now())
  alert      Alert?      @relation(fields: [alertId], references: [id], onDelete: Cascade)
  file       File?       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  order      Order?      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([orderId])
  @@index([userId])
}

model Clinic {
  id                                  String         @id @default(cuid())
  name                                String
  email                               String?
  phone                               String?
  address                             String?
  isActive                            Boolean        @default(true)
  laboratoryId                        String
  createdAt                           DateTime       @default(now())
  updatedAt                           DateTime       @updatedAt
  laboratory                          Laboratory     @relation(fields: [laboratoryId], references: [id], onDelete: Cascade)
  doctorMemberships                   DoctorClinic[] @relation("ClinicDoctorMemberships")
  orders                              Order[]
  assistants                          User[]         @relation("ClinicAssistants")
  clinicAdmins                        User[]         @relation("ClinicAdmins")

  @@index([isActive])
  @@index([laboratoryId])
}

model DoctorAssistant {
  id                                     String   @id @default(cuid())
  doctorId                               String
  assistantId                            String
  createdAt                              DateTime @default(now())
  assistant                              User     @relation("AssistantAssignments", fields: [assistantId], references: [id], onDelete: Cascade)
  doctor                                 User     @relation("DoctorAssignments", fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, assistantId])
  @@index([assistantId])
  @@index([doctorId])
}

model DoctorClinic {
  id        String   @id @default(cuid())
  doctorId  String
  clinicId  String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic   @relation("ClinicDoctorMemberships", fields: [clinicId], references: [id], onDelete: Cascade)
  doctor    User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, clinicId])
  @@index([clinicId])
  @@index([doctorId])
}

model File {
  id           String     @id @default(cuid())
  fileName     String
  originalName String
  fileType     String
  fileSize     Int
  mimeType     String
  storageKey   String     @unique
  storageUrl   String
  category     String?
  thumbnailUrl String?
  isProcessed  Boolean    @default(false)
  orderId      String
  uploadedById String
  createdAt    DateTime   @default(now())
  expiresAt    DateTime?
  deletedAt    DateTime?
  auditLogs    AuditLog[]
  order        Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  uploadedBy   User       @relation(fields: [uploadedById], references: [id])

  @@index([category])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([orderId])
  @@index([storageKey])
  @@index([uploadedById])
}

model Laboratory {
  id                                      String   @id @default(cuid())
  name                                    String
  email                                   String?
  phone                                   String?
  address                                 String?
  isActive                                Boolean  @default(true)
  createdAt                               DateTime @default(now())
  updatedAt                               DateTime @updatedAt
  clinics                                 Clinic[]
  labCollaborators                        User[]   @relation("LaboratoryCollaborators")
  labAdmins                               User[]   @relation("LaboratoryAdmins")

  @@index([isActive])
}

model Order {
  id                           String           @id @default(cuid())
  orderNumber                  String           @unique @default(cuid())
  patientName                  String
  patientId                    String?
  description                  String?
  notes                        String?
  fechaEntregaDeseada          DateTime?
  aiPrompt                     String?
  teethNumbers                 String?
  material                     String?
  materialBrand                String?
  color                        String?
  scanType                     ScanType?
  tipoCaso                     CaseType?        @default(nuevo)
  motivoGarantia               String?
  seDevuelveTrabajoOriginal    Boolean?
  tipoTrabajo                  WorkType?        @default(restauracion)
  tipoRestauracion             RestorationType?
  escanerUtilizado             ScannerType?
  otroEscaner                  String?
  tipoSilicon                  SiliconType?
  notaModeloFisico             String?
  trabajoSobreImplante         Boolean?         @default(false)
  informacionImplante          Json?
  materialSent                 Json?
  submissionType               SubmissionType?  @default(terminado)
  oclusionDiseno               Json?
  colorInfo                    Json?
  articulatedBy                ArticulatedBy?   @default(doctor)
  status                       OrderStatus      @default(DRAFT)
  clinicId                     String
  createdById                  String
  doctorId                     String
  createdAt                    DateTime         @default(now())
  updatedAt                    DateTime         @updatedAt
  submittedAt                  DateTime?
  materialsSentAt              DateTime?
  completedAt                  DateTime?
  alerts                       Alert[]
  auditLogs                    AuditLog[]
  files                        File[]
  clinic                       Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  createdBy                    User             @relation("CreatorOrders", fields: [createdById], references: [id], onDelete: Cascade)
  doctor                       User             @relation("DoctorOrders", fields: [doctorId], references: [id], onDelete: Cascade)
  comments                     OrderComment[]

  @@index([clinicId])
  @@index([createdAt])
  @@index([createdById])
  @@index([doctorId])
  @@index([orderNumber])
  @@index([status])
}

model OrderComment {
  id         String   @id @default(cuid())
  content    String
  isInternal Boolean  @default(false)
  orderId    String
  authorId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([isInternal])
  @@index([orderId])
}

model User {
  id                                                String            @id @default(cuid())
  email                                             String            @unique
  name                                              String
  passwordHash                                      String
  role                                              Role
  laboratoryId                                      String?
  labCollaboratorId                                 String?
  clinicId                                          String?
  activeClinicId                                    String?
  assistantClinicId                                 String?
  createdAt                                         DateTime          @default(now())
  updatedAt                                         DateTime          @updatedAt
  alertsReceived                                    Alert[]           @relation("AlertReceiver")
  alertsSent                                        Alert[]           @relation("AlertSender")
  auditLogs                                         AuditLog[]
  assignedDoctors                                   DoctorAssistant[] @relation("AssistantAssignments")
  assignedAssistants                                DoctorAssistant[] @relation("DoctorAssignments")
  clinicMemberships                                 DoctorClinic[]
  filesUploaded                                     File[]
  ordersCreated                                     Order[]           @relation("CreatorOrders")
  ordersByDoctor                                    Order[]           @relation("DoctorOrders")
  orderComments                                     OrderComment[]
  assistantClinic                                   Clinic?           @relation("ClinicAssistants", fields: [assistantClinicId], references: [id], onDelete: Cascade)
  clinic                                            Clinic?           @relation("ClinicAdmins", fields: [clinicId], references: [id], onDelete: Cascade)
  labCollaborator                                   Laboratory?       @relation("LaboratoryCollaborators", fields: [labCollaboratorId], references: [id], onDelete: Cascade)
  laboratory                                        Laboratory?       @relation("LaboratoryAdmins", fields: [laboratoryId], references: [id], onDelete: Cascade)

  @@index([activeClinicId])
  @@index([assistantClinicId])
  @@index([clinicId])
  @@index([email])
  @@index([laboratoryId])
  @@index([role])
}

enum AlertStatus {
  UNREAD
  READ
  RESOLVED
}

enum ArticulatedBy {
  doctor
  laboratorio
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  REGISTER
  FILE_UPLOAD
  FILE_DOWNLOAD
  FILE_DELETE
  STATUS_CHANGE
  ALERT_SENT
  ALERT_READ
}

enum CaseType {
  nuevo
  garantia
}

enum OrderStatus {
  DRAFT
  PENDING_REVIEW
  MATERIALS_SENT
  NEEDS_INFO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RestorationType {
  corona
  puente
  inlay
  onlay
  carilla
  provisional
}

enum Role {
  LAB_ADMIN
  LAB_COLLABORATOR
  CLINIC_ADMIN
  DOCTOR
  CLINIC_ASSISTANT
}

enum ScanType {
  DIGITAL_SCAN
  ANALOG_MOLD
}

enum ScannerType {
  iTero
  Medit
  ThreeShape
  Carestream
  Otro
}

enum SiliconType {
  adicion
  condensacion
}

enum SubmissionType {
  prueba_estructura
  prueba_estetica
  terminado
}

enum WorkType {
  restauracion
  otro
}
