generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Schema updated for per-tooth configuration - v2.0

model Alert {
  id                          String      @id @default(cuid())
  message                     String
  status                      AlertStatus @default(UNREAD)
  orderId                     String
  senderId                    String
  receiverId                  String
  createdAt                   DateTime    @default(now())
  readAt                      DateTime?
  resolvedAt                  DateTime?
  order                       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender                      User        @relation("AlertSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver                    User        @relation("AlertReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  auditLogs                   AuditLog[]

  @@index([createdAt])
  @@index([orderId])
  @@index([receiverId])
  @@index([senderId])
  @@index([status])
}

model AuditLog {
  id         String      @id @default(cuid())
  action     AuditAction
  entityType String
  entityId   String
  oldValue   String?
  newValue   String?
  metadata   Json?
  userId     String
  ipAddress  String?
  userAgent  String?
  orderId    String?
  fileId     String?
  alertId    String?
  createdAt  DateTime    @default(now())
  alert      Alert?      @relation(fields: [alertId], references: [id], onDelete: Cascade)
  file       File?       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  order      Order?      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([orderId])
  @@index([userId])
}

model File {
  id           String     @id @default(cuid())
  fileName     String
  originalName String
  fileType     String
  fileSize     Int
  mimeType     String
  storageKey   String     @unique
  storageUrl   String
  category     String?
  thumbnailUrl String?
  isProcessed  Boolean    @default(false)
  orderId      String
  uploadedById String
  createdAt    DateTime   @default(now())
  expiresAt    DateTime?
  deletedAt    DateTime?
  auditLogs    AuditLog[]
  order        Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  uploadedBy   User       @relation(fields: [uploadedById], references: [id])

  @@index([category])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([orderId])
  @@index([storageKey])
  @@index([uploadedById])
}

model Laboratory {
  id                                      String   @id @default(cuid())
  name                                    String
  email                                   String?
  phone                                   String?
  address                                 String?
  isActive                                Boolean  @default(true)
  createdAt                               DateTime @default(now())
  updatedAt                               DateTime @updatedAt
  labAdmins                               User[]   @relation("LaboratoryAdmins")
  doctors                                 User[]   @relation("LaboratoryDoctors")

  @@index([isActive])
}

model Order {
  id                           String           @id @default(cuid())
  orderNumber                  String           @unique @default(cuid())
  patientName                  String
  patientId                    String?
  description                  String?
  notes                        String?
  fechaEntregaDeseada          DateTime?
  aiPrompt                     String?
  teethNumbers                 String?
  initialToothStates           Json?              @default("{}")
  color                        String?
  isDigitalScan                Boolean          @default(false)
  tipoCaso                     CaseType?        @default(nuevo)
  motivoGarantia               String?
  seDevuelveTrabajoOriginal    Boolean?
  escanerUtilizado             ScannerType?
  otroEscaner                  String?
  materialSent                 Json?
  submissionType               SubmissionType?  @default(terminado)
  oclusionDiseno               Json?
  articulatedBy                ArticulatedBy?   @default(doctor)
  isUrgent                     Boolean          @default(false)
  status                       OrderStatus      @default(DRAFT)
  createdById                  String
  doctorId                     String
  createdAt                    DateTime         @default(now())
  updatedAt                    DateTime         @updatedAt
  submittedAt                  DateTime?
  materialsSentAt              DateTime?
  completedAt                  DateTime?
  deletedAt                    DateTime?
  alerts                       Alert[]
  auditLogs                    AuditLog[]
  files                        File[]
  teeth                        Tooth[]
  createdBy                    User             @relation("CreatorOrders", fields: [createdById], references: [id], onDelete: Cascade)
  doctor                       User             @relation("DoctorOrders", fields: [doctorId], references: [id], onDelete: Cascade)
  comments                     OrderComment[]

  @@index([createdAt])
  @@index([createdById])
  @@index([doctorId])
  @@index([orderNumber])
  @@index([status])
  @@index([isUrgent])
  @@index([deletedAt])
}

model Tooth {
  id                      String                @id @default(cuid())
  orderId                 String
  toothNumber             String
  material                String?
  colorInfo               Json?
  categoriaRestauracion   RestorationCategory?
  tipoRestauracion        RestorationType?
  trabajoSobreImplante    Boolean?              @default(false)
  informacionImplante     Json?
  solicitarProvisional    Boolean?              @default(false)
  materialProvisional     ProvisionalMaterial?
  solicitarJig            Boolean?              @default(false)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  order                   Order                 @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, toothNumber])
  @@index([orderId])
  @@index([toothNumber])
}

model OrderComment {
  id         String   @id @default(cuid())
  content    String
  isInternal Boolean  @default(false)
  orderId    String
  authorId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([isInternal])
  @@index([orderId])
}

model User {
  id                                                String            @id @default(cuid())
  email                                             String            @unique
  name                                              String
  passwordHash                                      String
  role                                              Role
  laboratoryId                                      String?
  doctorLaboratoryId                                String?
  clinicName                                        String?
  clinicAddress                                     String?
  phone                                             String?
  razonSocial                                       String?
  fiscalAddress                                     String?
  createdAt                                         DateTime          @default(now())
  updatedAt                                         DateTime          @updatedAt
  alertsReceived                                    Alert[]           @relation("AlertReceiver")
  alertsSent                                        Alert[]           @relation("AlertSender")
  auditLogs                                         AuditLog[]
  filesUploaded                                     File[]
  ordersCreated                                     Order[]           @relation("CreatorOrders")
  ordersByDoctor                                    Order[]           @relation("DoctorOrders")
  orderComments                                     OrderComment[]
  laboratory                                        Laboratory?       @relation("LaboratoryAdmins", fields: [laboratoryId], references: [id], onDelete: Cascade)
  doctorLaboratory                                  Laboratory?       @relation("LaboratoryDoctors", fields: [doctorLaboratoryId], references: [id], onDelete: Cascade)

  @@index([doctorLaboratoryId])
  @@index([email])
  @@index([laboratoryId])
  @@index([role])
}

enum AlertStatus {
  UNREAD
  READ
  RESOLVED
}

enum ArticulatedBy {
  doctor
  laboratorio
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  REGISTER
  FILE_UPLOAD
  FILE_DOWNLOAD
  FILE_DELETE
  STATUS_CHANGE
  ALERT_SENT
  ALERT_READ
}

enum CaseType {
  nuevo
  garantia
  regreso_prueba
  reparacion_ajuste
}

enum OrderStatus {
  DRAFT
  PENDING_REVIEW
  MATERIALS_SENT
  NEEDS_INFO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RestorationType {
  // Restauraciones por diente
  corona
  puente
  inlay
  onlay
  carilla
  provisional
  // Sobre implantes
  pilar
  barra
  hibrida
  toronto
  // Prótesis removible
  removible
  parcial
  total
  sobredentadura
  // Diagnóstico/Planificación
  encerado
  mockup
  guia_quirurgica
  prototipo
  guarda_oclusal
}

enum RestorationCategory {
  restauracion
  implante
  removible
  diagnostico
}

enum Role {
  LAB_ADMIN
  DOCTOR
}

enum ScannerType {
  iTero
  Medit
  ThreeShape
  Carestream
  DentalWings
  Otro
}

enum SubmissionType {
  prueba_estructura
  prueba_estetica
  prueba
  terminado
}

enum ToothInitialState {
  NORMAL
  AUSENTE
  PILAR
}

enum ProvisionalMaterial {
  acrilico
  bis_acrilico
  pmma
}

